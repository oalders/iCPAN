#!/usr/bin/env perl

=head1 SYNOPSIS

    ./bin/finish_db

Performs some basic tasks required to make the db safe for iOS. One important
task is to remove modules for which no Pod was produced.  No point in Podless
modules being imported into the app.

=cut

use Modern::Perl;
use Data::Printer;

use Find::Lib '../lib', '../../inc/Pod2HTML/lib';
use iCPAN;
use IO::File;

my $icpan  = iCPAN->new;
my $schema = $icpan->schema;

my $pod_rs
    = $icpan->schema->resultset( 'Zmodule' )
    ->search( { 'Pod.ZHTML' => undef },
    { order_by => 'zname ASC', prefetch => 'Pod' } );

my $fh = new IO::File "> MISSING_MODULES.txt";
if ( defined $fh ) {
    while ( my $module = $pod_rs->next ) {
        say $fh $module->zname;
    }
    $fh->close;
}

$pod_rs->reset;
$pod_rs->delete;

foreach my $table ( 'author', 'distribution', 'module', 'pod' ) {
    my $name = "Z$table";
    my $rs = $schema->resultset( "Z$table" );
    $icpan->update_ent( $rs, $icpan->get_ent( $name ) );
}

$icpan->schema->storage->dbh->do( "VACUUM" );
